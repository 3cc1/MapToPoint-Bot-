<!DOCTYPE html>
<html lang="en">
<head>
  <title>MapToPoint</title>
  <meta charset="utf-8" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: 300px;
      padding: 12px;
      background: #f5f5f5;
      border-right: 1px solid #ddd;
      overflow-y: auto;
    }

    label {
      font-size: 13px;
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    input, select {
      width: 100%;
      margin-bottom: 6px;
    }

    #map {
      flex: 1;
    }

    .event-item {
      padding: 8px;
      margin-bottom: 6px;
      background: white;
      border-left: 4px solid #ccc;
      cursor: pointer;
    }

    .event-item:hover {
      background: #eaeaea;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="sidebar">
    <h3>Events</h3>

    <label>Category</label>
    <select id="categoryFilter">
      <option value="ALL">All</option>
    </select>

    <label>Radius</label>
    <input type="range" id="radiusSlider" min="0" max="200" value="0">
    <span id="radiusValue">All distances</span>

    <label>Search</label>
    <input type="text" id="searchBox" placeholder="Search description..." />

    <label>Date</label>
    <input type="date" id="datePicker" />

    <hr>
    <div id="eventList"></div>
  </div>

  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
/* ---------------- CONFIG ---------------- */

const categoryColors = {
  Weather: "blue",
  Crime: "red",
  Sports: "green",
  Default: "gray"
};

/* ---------------- MAP ---------------- */

const map = L.map("map").setView([20, 0], 2);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap contributors"
}).addTo(map);

/* ---------------- STATE ---------------- */

let allEvents = [];
let markers = [];
let userLocation = null;
let radiusCircle = null;

/* ---------------- DOM ---------------- */

const eventList = document.getElementById("eventList");
const categoryFilter = document.getElementById("categoryFilter");
const radiusSlider = document.getElementById("radiusSlider");
const radiusValue = document.getElementById("radiusValue");
const searchBox = document.getElementById("searchBox");
const datePicker = document.getElementById("datePicker");

/* ---------------- LISTENERS ---------------- */

categoryFilter.onchange = render;
searchBox.oninput = render;
datePicker.onchange = render;

radiusSlider.oninput = () => {
  radiusValue.innerText =
    radiusSlider.value == 0
      ? "All distances"
      : radiusSlider.value + " km";
  render();
};

/* ---------------- GEOLOCATION ---------------- */

map.locate({ setView: true, maxZoom: 10 });

map.on("locationfound", e => {
  userLocation = { lat: e.latitude, lng: e.longitude };

  if (radiusCircle) map.removeLayer(radiusCircle);

  if (radiusSlider.value > 0) {
    radiusCircle = L.circle(e.latlng, {
      radius: radiusSlider.value * 1000
    }).addTo(map);
  }

  render();
});

/* ---------------- FETCH EVENTS ---------------- */

fetch("/api/events")
  .then(res => res.json())
  .then(data => {
    allEvents = data;
    populateCategories();
    render();
  });

function populateCategories() {
  const categories = new Set(allEvents.map(e => e.category));
  categories.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categoryFilter.appendChild(opt);
  });
}

/* ---------------- RENDER ---------------- */

function render() {
  clearMarkers();
  eventList.innerHTML = "";

  const radiusKm = Number(radiusSlider.value);
  const selectedCategory = categoryFilter.value;
  const searchText = searchBox.value.toLowerCase();
  const selectedDate = datePicker.value;

  allEvents.forEach(event => {

    if (selectedCategory !== "ALL" && event.category !== selectedCategory) return;

    if (searchText &&
        !event.description.toLowerCase().includes(searchText)) return;

    if (selectedDate && event.date && !event.date.startsWith(selectedDate)) return;

    if (
      userLocation &&
      radiusSlider.value > 0 &&
      getDistance(userLocation, event) > radiusKm
    ) return;

    const color = categoryColors[event.category] || categoryColors.Default;

    const marker = L.circleMarker([event.lat, event.lng], {
      radius: 7,
      color,
      fillOpacity: 0.8
    })
    .addTo(map)
    .bindPopup(`<b>${event.category}</b><br>${event.description}`);

    markers.push(marker);

    const item = document.createElement("div");
    item.className = "event-item";
    item.style.borderLeftColor = color;
    item.innerHTML = `<b>${event.category}</b><br>${event.description}`;
    item.onclick = () => {
      map.setView([event.lat, event.lng], 14);
      marker.openPopup();
    };

    eventList.appendChild(item);
  });
}

/* ---------------- HELPERS ---------------- */

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function getDistance(a, b) {
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;

  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;

  const h =
    Math.sin(dLat / 2) ** 2 +
    Math.sin(dLng / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);

  return 2 * R * Math.asin(Math.sqrt(h));
}
</script>

</body>
</html>
